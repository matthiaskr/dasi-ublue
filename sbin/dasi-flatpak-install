#!/bin/sh

REMOVAL_FILE=/var/.suspend-flatpak-removal
REMOVAL_AGE=$((60*60*24*30))

pkglist=${PACKAGES_FILE:-/usr/share/packages.lst}

dbus-run-session flatpak remote-add --system --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
dbus-run-session flatpak remote-modify --system --enable flathub

for i in $(dbus-run-session flatpak pin --system)
do
    dbus-run-session flatpak pin --system --remove $i
done
for i in $(dbus-run-session flatpak list --system --columns=application,origin --app | grep 'fedora$' | awk '{print $1}')
do
    dbus-run-session flatpak --system remove -y $i
done
for i in $(dbus-run-session flatpak list --system --columns=application,origin | grep 'fedora$' | awk '{print $1}')
do
    dbus-run-session flatpak --system remove -y $i
done
dbus-run-session flatpak remote-modify --system --disable fedora

if [ ! -f $REMOVAL_FILE ] || [ "$(cat $REMOVAL_FILE)" -lt $(( $(date '+%s') - $REMOVAL_AGE )) ]
then
    for i in $( (dbus-run-session flatpak list --app --columns application; cat $pkglist ; cat $pkglist ) | sort | uniq -u)
    do
        dbus-run-session flatpak --system remove -y $i
    done
fi
dbus-run-session flatpak remove --system --unused -y

for i in $(cat $pkglist)
do
    if ! ( flatpak list | grep -q $i )
    then
        dbus-run-session flatpak install --system -y flathub $i
    fi
done

dbus-run-session flatpak upgrade --system -y
