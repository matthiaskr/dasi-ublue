#!/bin/sh

pkglist=${PACKAGES_FILE:-/usr/share/packages.lst}
# TODO: do not remove unwanted packages everytime

dbus-run-session flatpak remote-add --system --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
dbus-run-session flatpak remote-modify --system --enable flathub

for i in $(dbus-run-session flatpak pin --system)
do
    dbus-run-session flatpak pin --system --remove
done
for i in $(dbus-run-session flatpak list --system --columns=application,origin --app | grep 'fedora$' | awk '{print $1}')
do
    dbus-run-session flatpak --system remove -y
done
for i in $(dbus-run-session flatpak list --system --columns=application,origin | grep 'fedora$' | awk '{print $1}')
do
    dbus-run-session flatpak --system remove -y
done
dbus-run-session flatpak remote-modify --system --disable fedora

if [ ! -z "$CLEAN_UNWANTED_PACKAGES" ]
then
    for i in $( (dbus-run-session flatpak list --app --columns application; cat $pkglist ; cat $pkglist ) | sort | uniq -u)
    do
        dbus-run-session flatpak --system remove -y
    done
fi

for i in $(cat $pkglist)
do
    if ! ( flatpak list | grep -q $i )
    then
        dbus-run-session flatpak install --system -y flathub $i
    fi
done
